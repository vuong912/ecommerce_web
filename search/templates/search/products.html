{% extends 'customer_base.html' %}
{% load static %}
{% load url_helper %}
{% load humanize %}
{% block content %}
<section class="page-search">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <!-- Advance Search -->
                <div class="advance-search">
                    <form method="GET" action="{% url 'search:search' %}">
                        <div class="form-row">
                            <div class="form-group col-md-10">
                                <input name="q" type="text" class="form-control my-2 my-lg-0" id="inputtext4"
                                    placeholder="Tìm kiếm trên Chợ Sách">
                            </div>
                            <div class="form-group col-md-2">
                                <button type="submit" class="btn btn-primary">Tìm kiếm</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
<section class="section-sm">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="search-result bg-gray">
                    <h2>Results For "Electronics"</h2>
                    <p>123 Results on 12 December, 2017</p>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3">
                <div class="category-sidebar">
                    {% if current_category %}
                    <div class="widget category-list">
                        <h4 class="widget-header">
                            <a href="{% url 'book:get_books' current_category.url_name %}">{{ current_category.name }}</a>
                        </h4>
                        <ul class="category-list">
                            {% for item in children_categories %}
                            <li>
                                <a href="{% url 'book:get_books' item.url_name %}">{{ item.name }}<span>{{ item.num_books }}</span></a>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    <div class="widget category-list">
                        <h4 class="widget-header">Địa điểm</h4>
                        <ul class="category-list">
                            {% with params=request.GET.urlencode %}
                            {% for city in cities %}
                            <li><a href="{% query_url 'location' city.id params %}">{{city.id}} <span>{{city.num_books}}</span></a></li>
                            {% endfor %}
                            {% endwith %}
                        </ul>
                    </div>

                    <div class="widget price-range w-100">
                        <h4 class="widget-header">Giá</h4>
                        <div class="block text-center">
                            <input type="number" class="form-control" name="low_price" id="low_price" value="{{request.GET.low_price}}" min=0 placeholder="Tối thiểu">
                            <br>
                            <input type="number" class="form-control" name="high_price" id="high_price" value="{{request.GET.high_price}}" min=0 placeholder="Tối đa">
                            <br>
                            <button onclick="price_filter()" class="btn btn-contact d-inline-block btn-primary px-lg-5 my-1 px-md-3">Áp dụng</button>
                        </div>
                    </div>

                    <div class="widget category-list">
                        <h4 class="widget-header">Tình trạng</h4>
                        <ul class="category-list">
                            {% with params=request.GET.urlencode %}
                            {% for condition in conditions %}
                            <li><a href="{% query_url 'condition' condition.code params %}">{{condition.name}} <span>{{condition.num_books}}</span></a></li>
                            {% endfor %}
                            {% endwith %}
                        </ul>
                    </div>

                </div>
            </div>
            <div class="col-md-9">
                <div class="category-search-filter">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Sắp xếp</strong>
                            {% with sorted=request.GET.sort %}
                            <select onchange="location = this.value;">
                                <option {%if sorted == 'newest'%}selected{%endif%}
                                    value="{% query_url 'sort' 'newest' request.GET.urlencode %}">Hàng mới</option>
                                <option {%if sorted == 'hotest'%}selected{%endif%}
                                    value="{% query_url 'sort' 'hotest' request.GET.urlencode %}">Bán chạy</option>
                                <option {%if sorted == 'lowest_price'%}selected{%endif%}
                                    value="{% query_url 'sort' 'lowest_price' request.GET.urlencode %}">Giá thấp
                                </option>
                                <option {%if sorted == 'highest_price'%}selected{%endif%}
                                    value="{% query_url 'sort' 'highest_price' request.GET.urlencode %}">Giá cao
                                </option>
                            </select>
                            {% endwith%}
                        </div>
                    </div>
                </div>
                <div class="product-grid-list">
                    <div class="row mt-30">
                        {% for book in pager %}
                        <div class="col-sm-12 col-lg-4 col-md-6">
                            <!-- product card -->
                            <div class="product-item bg-light">
                                <div class="card">
                                    <div class="thumb-content">
                                        <!-- <div class="price">$200</div> -->
                                        <a href="{% url 'book:get_book' book.id %}">
                                            <img class="card-img-top img-fluid" src="{{ book.url }}"
                                                alt="Card image cap">
                                        </a>
                                    </div>
                                    <div class="card-body">
                                        <h4 class="card-title"><a
                                                href="{% url 'book:get_book' book.id %}">{{ book.name }}</a></h4>
                                        <ul class="list-inline product-meta">
                                            <li class="list-inline-item">
                                                <a href="{% url 'book:get_book' book.id %}"><i
                                                        class="fa fa-folder-open-o"></i>{{ book.category }}</a>
                                            </li>
                                        </ul>
                                        <div class="price">
                                            <h5>{{ book.price|floatformat:0|intcomma }} đ</h5>
                                            {% if book.origin_price != book.price %}
                                            <p><strike>{{ book.origin_price|floatformat:0|intcomma }} đ</strike>
                                                {{ book.get_saving_rate|floatformat:0 }}%</p>
                                            {% endif %}
                                        </div>
                                        <p class="card-text">{{ book.description|truncatechars:100 }}</p>
                                        <div class="product-ratings list-inline">
                                            <ul class="list-inline list-inline-item">
                                                {% with t_star=book.rate_point|floatformat:0 %}
                                                {% for i in "12345" %}
                                                <li class="list-inline-item {% if i <= t_star %}selected{% endif %}">
                                                    <i class="fa fa-star" style="font-size: 1em;"></i>
                                                </li>
                                                {% endfor%}
                                                {% endwith %}
                                            </ul>
                                            <p class="list-inline-item" style="padding-left: 2em;">{{book.city}}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="pagination justify-content-center">
                    <nav aria-label="Page navigation example">
                        <ul class="pagination">
                            {% if pager.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="#" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                    <span class="sr-only">Previous</span>
                                </a>
                            </li>
                            {% endif %}
                            {% for page_index in page_navigator %}
                            {% ifequal page_index pager.number %}
                            <li class="page-item active"><a class="page-link"
                                    href="?page={{ page_index }}">{{page_index}}</a></li>
                            {% else %}
                            <li class="page-item"><a class="page-link" href="?page={{ page_index }}">{{page_index}}</a>
                            </li>
                            {% endifequal %}
                            {% endfor %}
                            {% if pager.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="#" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                    <span class="sr-only">Next</span>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}
{% block js %}
<script>
    function price_filter(){
        low_price = document.getElementById("low_price").value
        high_price = document.getElementById("high_price").value
        var urlParams = new URLSearchParams(window.location.search);
        //urlParams.append('low_price', low_price)
        if(urlParams.has("low_price") === true){
            urlParams.set("low_price", low_price)
        } else {
            urlParams.append("low_price", low_price)
        }
        if(urlParams.has("high_price") === true){
            urlParams.set("high_price", high_price)
        } else {
            urlParams.append("high_price", high_price)
        }
        location.href = "?"+urlParams.toString()
    }
</script>
{% endblock %}